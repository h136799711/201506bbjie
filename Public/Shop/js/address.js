define(["jquery","person/common"],function(e){return{run:function(t){function s(t,n){obj_global=n;if(!t)return alert("没有可以编辑的地址"),!1;e.ajax({url:"index.php?app=my_address&act=edit&addr_id="+t,type:"GET",dataType:"json",success:function(t){if(t.status==2)alert(t.msg);else{var n=t.address;e('*[name="addr_id"]').val(n.addr_id),e('*[name="consignee"]').val(n.consignee),e('*[name="region_id"]').val(n.region_id),e('*[name="region_name"]').val(n.region_name),e('*[name="address"]').val(n.address),e('*[name="zipcode"]').val(n.zipcode),e('*[name="phone_tel"]').val(n.phone_tel),e('*[name="quhao"]').val(n.quhao),e('*[name="phone_mob"]').val(n.phone_mob),e('*[name="number"]').val(n.number),e('select[name="province_id"]').nextAll("select").remove(),e('select[name="province_id"]').hide(),e('select[name="province_id"]').nextAll("label").hide();var r="<span>"+n.region_name+"</span>"+'<a class="edit_region btn btn-info" href="javascript:void(0)">编辑</a>';e(".html_editor").html(r)}}})}function o(t){t.nextAll("select").remove();var n=t.siblings("select").andSelf(),r=0,s=new Array;for(i=0;i<n.length;i++)sel=n[i],sel.value>0&&(r=sel.value,name=sel.options[sel.selectedIndex].text,s.push(name));e(".mls_id").val(r),e(".mls_name").val(name),e(".mls_names").val(s.join(" "));if(sel.value>0){var o=t[0],u="index.php?app=mlselection&type=region";e.getJSON(u,{pid:sel.value},function(t){if(t.done){if(t.retval.length>0){$this=e("<select><option>请选择...</option></select>"),$this.insertAfter(o);var t=t.retval;for(i=0;i<t.length;i++)e(o).next("select").append("<option value='"+t[i].region_id+"'>"+t[i].region_name+"</option>")}}else alert(t.msg)})}}function u(e){e.parent().siblings("select").show(),e.parent().siblings("span").andSelf().hide()}var n=_.template(e("#address_form").length?e("#address_form").html():""),r=_.template(e("#addr_moban").length?e("#addr_moban").html():"");t.data("form",n).on("change","#region select",function(){o(e(this))}),t.find(".edit_region").live("click",function(){u(e(this))}),t.find(".edit_address").live("click",function(){var t=e(this).attr("addr_id");s(t,this)}),t.find(".address_from").validate({submitHandler:function(t){return e('[name="phone_tel"]').val()==""&&e('[name="phone_mob"]').val()==""?(alert("联系手机号码与联系电话必须填写一个"),!1):e('[name="phone_mob"]').val()!=""&&e('[name="quhao"]').val()==""?(alert("联系电话请填写区号"),!1):e('[name="region_id"]').val()==""||e('[name="region_id"]').val()==null?(alert("请选择您的所在区域"),!1):(e(".address_from").ajaxSubmit({dataType:"json",success:function(t){t.status==2&&alert(t.msg);if(t.status==1){var n=t.msg;e("#address").append(r({addr_id:t.addr_id,consignee:n.consignee,phone_tel:n.phone_tel,phone_mob:n.phone_mob,region_name:n.region_name,address:n.address,anti:n.anti,zipcode:n.zipcode})),e.mine_modal("hide")}}}),!1)},onkeyup:!1,rules:{consignee:{required:!0},region_id:{required:!0},zipcode:{required:!0},phone_tel:{minlength:11},phone_mob:{digits:!0}},messages:{consignee:{required:"请填写联系人姓名. "},region_id:{required:"请选择所在区域. "},zipcode:{required:"请填写邮政编码."},phone_tel:{minlength:"手机号码至少11位. "},phone_mob:{minlength:"",digits:"错误的电话格式. "}}})}}});